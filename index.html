<!-- ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... -->

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const menuContainer = document.getElementById('menuContainer');
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const chatArea = document.getElementById('chatArea');

    let currentMode = '';
    let chatHistory = [];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
    const urlParams = new URLSearchParams(window.location.search);
    const historyParam = urlParams.get('history');
    if (historyParam) {
        try {
            chatHistory = JSON.parse(decodeURIComponent(historyParam));
            startChat('chat');
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            chatHistory.forEach(msg => {
                addMessage(msg.content, msg.role === 'user');
            });
        } catch (error) {
            console.error('Error parsing chat history:', error);
            showMenu();
        }
    } else {
        showMenu();
    }

    function showMenu() {
        menuContainer.style.display = 'flex';
        chatContainer.style.display = 'none';
    }

    function startChat(mode) {
        currentMode = mode;
        menuContainer.style.display = 'none';
        chatContainer.style.display = 'block';
        
        if (!historyParam) {
            chatArea.innerHTML = '';
            let welcomeMessage = '';
            switch(mode) {
                case 'chat':
                    welcomeMessage = 'üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å!';
                    break;
                case 'image':
                    welcomeMessage = 'üé® –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å!';
                    break;
                case 'help':
                    welcomeMessage = '‚ùì –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
                    break;
            }
            addMessage(welcomeMessage, false);
        }
        messageInput.focus();
    }

    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        messageDiv.textContent = text;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        addMessage(message, true);
        messageInput.value = '';

        try {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            chatHistory.push({
                role: 'user',
                content: message
            });

            await tg.sendData(JSON.stringify({
                action: currentMode,
                text: message,
                history: chatHistory
            }));
        } catch (error) {
            addMessage('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', false);
            console.error('Error:', error);
        }
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
</script>
