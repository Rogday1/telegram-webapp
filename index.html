<!-- ... остальной код без изменений ... -->

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const chatArea = document.getElementById('chatArea');

    // Проверяем URL на наличие сообщения и ответа
    const urlParams = new URLSearchParams(window.location.search);
    const message = urlParams.get('message');
    const response = urlParams.get('response');
    
    if (message && response) {
        // Показываем предыдущее сообщение и ответ
        addMessage(decodeURIComponent(message), true);
        addMessage(decodeURIComponent(response), false);
    }

    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        messageDiv.textContent = text;
        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Блокируем интерфейс
        messageInput.disabled = true;
        sendButton.disabled = true;

        // Добавляем сообщение пользователя
        addMessage(message, true);
        messageInput.value = '';

        try {
            // Показываем индикатор загрузки
            addMessage('⌛ Ожидание ответа...', false);

            // Отправляем сообщение через Telegram WebApp
            await tg.sendData(JSON.stringify({
                action: 'chat',
                text: message
            }));

            // Удаляем индикатор загрузки
            chatArea.removeChild(chatArea.lastChild);

            // Закрываем веб-приложение
            tg.close();

        } catch (error) {
            console.error('Error:', error);
            // Удаляем индикатор загрузки
            chatArea.removeChild(chatArea.lastChild);
            addMessage('❌ Ошибка отправки сообщения', false);
            
            // Разблокируем интерфейс
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    // ... остальной код без изменений ...
</script>
